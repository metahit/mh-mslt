cause=disease)
disease_life_table_sc <- bind_rows(disease_life_table_list_sc, .id = "age_sex_disease_cohort") %>%
mutate(age_sex_disease_cohort = as.numeric(gsub("_.*","",age_sex_disease_cohort))) %>%
rename(age_group=age_sex_disease_cohort,
cause=disease)
### Run scenario non diseases
non_disease_life_table_list_sc <- list()
for (i in 1:nrow(age_sex_non_disease_cohorts)){
# i=6
td1_age_sex <- mslt_df %>% ### new mslt dataframe with modified injuries and lri deaths and ylds rates
filter(age >= age_sex_non_disease_cohorts$age[i] & sex == age_sex_non_disease_cohorts$sex[i])
pif_colname_deaths <- paste0('pif_',age_sex_non_disease_cohorts$acronym[i], '_deaths')
pif_colname_ylds <- paste0('pif_',age_sex_non_disease_cohorts$acronym[i], '_ylds')
pif_non_disease <- pif_expanded %>%
filter(age >= age_sex_non_disease_cohorts$age[i] & sex == age_sex_non_disease_cohorts$sex[i]) %>%
dplyr::select(age,sex,pif_colname_deaths,pif_colname_ylds)
death_colname <- paste0('deaths_rate_', age_sex_non_disease_cohorts$sname[i])
ylds_colname <- paste0('ylds_rate_', age_sex_non_disease_cohorts$sname[i])
new_deaths <- td1_age_sex%>%pull(death_colname) * (1 - (pif_non_disease%>%pull(pif_colname_deaths)))
new_deaths[is.na(new_deaths)] <- 0
new_ylds <- td1_age_sex%>%pull(ylds_colname) * (1 - (pif_non_disease%>%pull(pif_colname_ylds)))
new_ylds[is.na(new_ylds)] <- 0
td1_age_sex[[death_colname]] <- new_deaths
td1_age_sex[[ylds_colname]] <- new_ylds
## Instead of idata, feed td to run scenarios. Now all non_diseases are run again
non_disease_life_table_list_sc[[i]] <- RunNonDisease(
in_idata         = td1_age_sex,
in_sex           = age_sex_non_disease_cohorts$sex[i],
in_mid_age       = age_sex_non_disease_cohorts$age[i],
in_non_disease   = age_sex_non_disease_cohorts$sname[i]
)
names(non_disease_life_table_list_sc)[i] <- age_sex_non_disease_cohorts$cohort[i]
}
### Difference rates
for (cohort in age_sex_non_disease_cohorts$cohort) {
non_disease_life_table_list_sc[[cohort]]$diff_mort <-
non_disease_life_table_list_sc[[cohort]]$deaths_rate -  non_disease_life_table_list_bl[[cohort]]$deaths_rate
non_disease_life_table_list_sc[[cohort]]$diff_pylds <-
non_disease_life_table_list_sc[[cohort]]$ylds_rate -  non_disease_life_table_list_bl[[cohort]]$ylds_rate }
# convert the list of dataframes to single dataframes
non_disease_life_table_bl <- bind_rows(non_disease_life_table_list_bl, .id = "age_sex_non_disease_cohort") %>%
mutate(age_sex_non_disease_cohort = as.numeric(gsub("_.*","",age_sex_non_disease_cohort))) %>%
rename(age_group=age_sex_non_disease_cohort,
cause=non_disease,
mx=deaths_rate)
non_disease_life_table_sc <- bind_rows(non_disease_life_table_list_sc, .id = "age_sex_non_disease_cohort") %>%
mutate(age_sex_non_disease_cohort = as.numeric(gsub("_.*","",age_sex_non_disease_cohort))) %>%
rename(age_group=age_sex_non_disease_cohort,
cause=non_disease,
mx=deaths_rate)
### Add up mortality and pylds changes
### Diseases: Sum mortality rate and pylds change scenarios
mx_pylds_sc_total_disease_df <- disease_life_table_sc %>%
group_by(age_group,sex,age) %>%
summarise(mortality_sum=sum(diff_mort_disease,na.rm=T),
pylds_sum=sum(diff_pylds_disease,na.rm=T)) %>%
ungroup() %>%
mutate(age_sex_cohort=paste0(age_group,'_',sex))
### Non-diseases
mx_pylds_sc_total_non_disease_df <- non_disease_life_table_sc %>%
group_by(age_group,sex,age) %>%
summarise(mortality_sum=sum(diff_mort,na.rm=T),
pylds_sum=sum(diff_pylds,na.rm=T)) %>%
ungroup() %>%
mutate(age_sex_cohort=paste0(age_group,'_',sex))
### Run scenario life tables
general_life_table_list_sc <- list()
for (i in 1:nrow(age_sex_cohorts)){
# modify idata's mortality and pyld total for the said scenario
mx_pylds_sc_total_disease_df_cohort <- mx_pylds_sc_total_disease_df %>%
filter(age_sex_cohort==age_sex_cohorts$cohort[i]) %>%
dplyr::select(age,mortality_sum,pylds_sum)
mx_pylds_sc_total_non_disease_df_cohort <- mx_pylds_sc_total_non_disease_df %>%
filter(age_sex_cohort==age_sex_cohorts$cohort[i]) %>%
dplyr::select(age,mortality_sum,pylds_sum)
### Modify rates in static MSLT  (pylds are always static, mx can include future trends)
#### With diseases changes in mortality and ylds
td2 <- mslt_df %>%
filter(sex==age_sex_cohorts$sex[i]) %>%
left_join(mx_pylds_sc_total_disease_df_cohort,by="age") %>%
mutate(mx=mx+replace_na(mortality_sum,0),
pyld_rate=pyld_rate+replace_na(pylds_sum,0)) %>%
dplyr::select(-mortality_sum,-pylds_sum)
#### With diseases changes in mortality and ylds
td3 <-  td2 %>%
filter(sex==age_sex_cohorts$sex[i]) %>%
left_join(mx_pylds_sc_total_non_disease_df_cohort,by="age") %>%
mutate(mx=mx+replace_na(mortality_sum,0),
pyld_rate=pyld_rate+replace_na(pylds_sum,0)) %>%
dplyr::select(-mortality_sum,-pylds_sum)
# ### Modify death rates with future trends NOT AVAILABLE FOR METAHIT
# td3 <- death_projections %>%
#   mutate(cohort=paste(age_cohort, sex, sep = "_")) %>% # variable to match change in mortality rates df
#   filter(cohort==age_sex_cohorts$cohort[i]) %>%
#   left_join(mx_pylds_sc_total_disease_df_cohort) %>%
#   mutate(rate=rate+replace_na(mortality_sum,0))%>%
#   dplyr::select(-mortality_sum,-pylds_sum)
suppressWarnings(
general_life_table_list_sc[[i]] <- RunLifeTable(
in_idata    = td3,
in_sex      = age_sex_cohorts$sex[i],
in_mid_age  = age_sex_cohorts$age[i],
death_rates = NA
))
names(general_life_table_list_sc)[i] <- age_sex_cohorts$cohort[i]
}
# convert the list of dataframes to single dataframes
general_life_table_sc <- bind_rows(general_life_table_list_sc, .id = "age_group") %>%
mutate(age_group = as.numeric(gsub("_.*","",age_group)))
## In the following list 'output_life_table', 34 data frames are nested per age and sex cohort
## Outputs are generated following the index order of disease life tables baseline and scenarios where ##diabetes is     firstcalculated as it impacts on cardiovascular diseases.
### Generate outputs dataframe
#### Diseases life tables
dia_index <- which(DISEASE_SHORT_NAMES$sname=='dmt2')
dia_order <- c(dia_index,c(1:nrow(DISEASE_SHORT_NAMES))[-dia_index])
### Combine diseases and general life tables for scenarios
### Step needed to calculate numbers (rates*people cohort)
dia_index <- which(DISEASE_SHORT_NAMES$sname=='dmt2')
dia_order <- c(dia_index,c(1:nrow(DISEASE_SHORT_NAMES))[-dia_index])
scenario_d <- inner_join(disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,incidence_disease,mx,px),
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx),
by=c("age","sex","age_group")) %>%
mutate(intervention="sc")
baseline_d <- inner_join(disease_life_table_bl %>%
dplyr::select(age_group,sex,age,cause,incidence_disease,mx,px),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx),
by=c("age","sex","age_group")) %>%
mutate(intervention="bl")
disease_combined <- bind_rows(disease_sc,disease_bl) %>%
pivot_wider(names_from  = intervention,
values_from = c(incidence_disease,mx,px,Lx,ex,Lwx,ewx)) %>%
mutate(inc_num_bl   = incidence_disease_bl*(1-px_bl)*Lx_bl,
inc_num_sc   = incidence_disease_sc*(1-px_sc)*Lx_sc,
inc_num_diff = inc_num_sc-inc_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = disease,
values_from = incidence_disease_sc:mx_num_diff)
disease_combined <- bind_rows(scenario_d,baseline_d) %>%
pivot_wider(names_from  = intervention,
values_from = c(incidence_disease,mx,px,Lx),
values_fill = 0) %>%
mutate(inc_num_bl   = incidence_disease_bl*(1-px_bl)*Lx_bl,
inc_num_sc   = incidence_disease_sc*(1-px_sc)*Lx_sc,
inc_num_diff = inc_num_sc-inc_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = cause,
values_from = inc_num_bl:mx_num_diff,
values_fill = 0) %>%
dplyr::select(-starts_with(c("Lx", "px", "incidence_")))
### Non_diseases life tables
scenario_nd <- inner_join(non_disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,mx,ylds_rate, diff_mort, diff_pylds),
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx),
by=c("age","sex","age_group")) %>%
mutate(intervention="sc")
baseline_nd <- inner_join(non_disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,mx,ylds_rate, diff_mort, diff_pylds),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx),
by=c("age","sex","age_group")) %>%
mutate(intervention="bl")
non_disease_combined <- bind_rows(scenario_nd,baseline_nd) %>%
pivot_wider(names_from  = intervention,
values_from = c(mx, ylds_rate, Lx,
values_fill=0)) %>%
mutate(ylds_num_bl   = ylds_rate_bl*Lx_bl,
ylds_num_sc   = ylds_rate_sc*Lx_sc,
ylds_num_diff = ylds_num_sc-ylds_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = cause,
values_from = diff_mort:mx_num_diff,
values_fill=0) %>%
dplyr::select(-starts_with("Lx"))
### General life tables
general_lf <- bind_rows(
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx) %>%
mutate(intervention="sc"),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx) %>%
mutate(intervention="bl")) %>%
pivot_wider(names_from  = intervention,
values_from = c(Lx,ex,Lwx,ewx),
values_fill=0) %>%
mutate(Lx_diff  = Lx_sc-Lx_bl,
Lwx_diff = Lwx_sc-Lwx_bl,
ex_diff  = ex_sc-ex_bl,
ewx_diff = ewx_sc-ewx_bl)
######## Dataframe with all outputs by age and sex cohort over the simulation years (years of the cohort)
output_df <- inner_join(disease_combined,
general_lf,
by=c("age","sex","age_group")) %>%
inner_join(non_disease_combined,
by=c("age","sex","age_group"))
### Generte outputs
#### Summary data frame by age and sex and total
######## Dataframe with all outputs aggregated by year of simlation by sex
output_df_agg_sex  <- output_df   %>% ### Create a simulation year columns
group_by(age_group, sex, .add=TRUE) %>%
dplyr::mutate(year = 1:dplyr::n()) %>%
dplyr::select(sex, year, Lx_bl, Lx_sc, Lx_diff, Lwx_bl, Lwx_sc, Lwx_diff, contains("num")) %>%
ungroup() %>%
group_by(year, sex, .add=TRUE) %>%
summarise_if(is.numeric, funs(sum)) %>%
ungroup()
View(output_df)
dia_index <- which(DISEASE_SHORT_NAMES$sname=='dmt2')
dia_order <- c(dia_index,c(1:nrow(DISEASE_SHORT_NAMES))[-dia_index])
scenario_d <- inner_join(disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,incidence_disease,mx,px),
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx),
by=c("age","sex","age_group")) %>%
mutate(intervention="sc")
baseline_d <- inner_join(disease_life_table_bl %>%
dplyr::select(age_group,sex,age,cause,incidence_disease,mx,px),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx),
by=c("age","sex","age_group")) %>%
mutate(intervention="bl")
disease_combined <- bind_rows(disease_sc,disease_bl) %>%
pivot_wider(names_from  = intervention,
values_from = c(incidence_disease,mx,px,Lx,ex,Lwx,ewx)) %>%
mutate(inc_num_bl   = incidence_disease_bl*(1-px_bl)*Lx_bl,
inc_num_sc   = incidence_disease_sc*(1-px_sc)*Lx_sc,
inc_num_diff = inc_num_sc-inc_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = disease,
values_from = incidence_disease_sc:mx_num_diff)
disease_combined <- bind_rows(scenario_d,baseline_d) %>%
pivot_wider(names_from  = intervention,
values_from = c(incidence_disease,mx,px,Lx),
values_fill = 0) %>%
mutate(inc_num_bl   = incidence_disease_bl*(1-px_bl)*Lx_bl,
inc_num_sc   = incidence_disease_sc*(1-px_sc)*Lx_sc,
inc_num_diff = inc_num_sc-inc_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = cause,
values_from = inc_num_bl:mx_num_diff,
values_fill = 0) %>%
dplyr::select(-starts_with(c("Lx", "px", "incidence_")))
### Non_diseases life tables
scenario_nd <- inner_join(non_disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,mx,ylds_rate, diff_mort, diff_pylds),
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx),
by=c("age","sex","age_group")) %>%
mutate(intervention="sc")
baseline_nd <- inner_join(non_disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,mx,ylds_rate, diff_mort, diff_pylds),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx),
by=c("age","sex","age_group")) %>%
mutate(intervention="bl")
non_disease_combined <- bind_rows(scenario_nd,baseline_nd) %>%
pivot_wider(names_from  = intervention,
values_from = c(mx, ylds_rate, Lx,
values_fill=0)) %>%
mutate(ylds_num_bl   = ylds_rate_bl*Lx_bl,
ylds_num_sc   = ylds_rate_sc*Lx_sc,
ylds_num_diff = ylds_num_sc-ylds_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = cause,
values_from = diff_mort:mx_num_diff,
values_fill=0) %>%
dplyr::select(-starts_with("Lx"))
### General life tables
general_lf <- bind_rows(
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx) %>%
mutate(intervention="sc"),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx) %>%
mutate(intervention="bl")) %>%
pivot_wider(names_from  = intervention,
values_from = c(Lx,ex,Lwx,ewx),
values_fill=0) %>%
mutate(Lx_diff  = Lx_sc-Lx_bl,
Lwx_diff = Lwx_sc-Lwx_bl,
ex_diff  = ex_sc-ex_bl,
ewx_diff = ewx_sc-ewx_bl)
######## Dataframe with all outputs by age and sex cohort over the simulation years (years of the cohort)
output_df <- inner_join(disease_combined,
general_lf,
by=c("age","sex","age_group")) %>%
inner_join(non_disease_combined,
by=c("age","sex","age_group"))
### Generte outputs
#### Summary data frame by age and sex and total
######## Dataframe with all outputs aggregated by year of simlation by sex
output_df_agg_sex  <- output_df   %>% ### Create a simulation year columns
group_by(age_group, sex, .add=TRUE) %>%
dplyr::mutate(year = 1:dplyr::n()) %>%
dplyr::select(sex, year, Lx_bl, Lx_sc, Lx_diff, Lwx_bl, Lwx_sc, Lwx_diff, contains("num")) %>%
ungroup() %>%
group_by(year, sex, .add=TRUE) %>%
summarise_if(is.numeric, funs(sum)) %>%
ungroup()
disease_combined <- bind_rows(scenario_d ,baseline_d) %>%
pivot_wider(names_from  = intervention,
values_from = c(incidence_disease,mx,px,Lx,ex,Lwx,ewx)) %>%
mutate(inc_num_bl   = incidence_disease_bl*(1-px_bl)*Lx_bl,
inc_num_sc   = incidence_disease_sc*(1-px_sc)*Lx_sc,
inc_num_diff = inc_num_sc-inc_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = disease,
values_from = incidence_disease_sc:mx_num_diff)
disease_combined <- bind_rows(scenario_d,baseline_d) %>%
pivot_wider(names_from  = intervention,
values_from = c(incidence_disease,mx,px,Lx),
values_fill = 0) %>%
mutate(inc_num_bl   = incidence_disease_bl*(1-px_bl)*Lx_bl,
inc_num_sc   = incidence_disease_sc*(1-px_sc)*Lx_sc,
inc_num_diff = inc_num_sc-inc_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = cause,
values_from = inc_num_bl:mx_num_diff,
values_fill = 0) %>%
dplyr::select(-starts_with(c("Lx", "px", "incidence_")))
### Non_diseases life tables
scenario_nd <- inner_join(non_disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,mx,ylds_rate, diff_mort, diff_pylds),
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx),
by=c("age","sex","age_group")) %>%
mutate(intervention="sc")
baseline_nd <- inner_join(non_disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,mx,ylds_rate, diff_mort, diff_pylds),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx),
by=c("age","sex","age_group")) %>%
mutate(intervention="bl")
non_disease_combined <- bind_rows(scenario_nd,baseline_nd) %>%
pivot_wider(names_from  = intervention,
values_from = c(mx, ylds_rate, Lx,
values_fill=0)) %>%
mutate(ylds_num_bl   = ylds_rate_bl*Lx_bl,
ylds_num_sc   = ylds_rate_sc*Lx_sc,
ylds_num_diff = ylds_num_sc-ylds_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = cause,
values_from = diff_mort:mx_num_diff,
values_fill=0) %>%
dplyr::select(-starts_with("Lx"))
### General life tables
general_lf <- bind_rows(
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx) %>%
mutate(intervention="sc"),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx) %>%
mutate(intervention="bl")) %>%
pivot_wider(names_from  = intervention,
values_from = c(Lx,ex,Lwx,ewx),
values_fill=0) %>%
mutate(Lx_diff  = Lx_sc-Lx_bl,
Lwx_diff = Lwx_sc-Lwx_bl,
ex_diff  = ex_sc-ex_bl,
ewx_diff = ewx_sc-ewx_bl)
######## Dataframe with all outputs by age and sex cohort over the simulation years (years of the cohort)
output_df <- inner_join(disease_combined,
general_lf,
by=c("age","sex","age_group")) %>%
inner_join(non_disease_combined,
by=c("age","sex","age_group"))
### Generte outputs
#### Summary data frame by age and sex and total
######## Dataframe with all outputs aggregated by year of simlation by sex
output_df_agg_sex  <- output_df   %>% ### Create a simulation year columns
group_by(age_group, sex, .add=TRUE) %>%
dplyr::mutate(year = 1:dplyr::n()) %>%
dplyr::select(sex, year, Lx_bl, Lx_sc, Lx_diff, Lwx_bl, Lwx_sc, Lwx_diff, contains("num")) %>%
ungroup() %>%
group_by(year, sex, .add=TRUE) %>%
summarise_if(is.numeric, funs(sum)) %>%
ungroup()
disease_combined <- bind_rows(scenario_d ,baseline_d) %>%
pivot_wider(names_from  = intervention,
values_from = c(incidence_disease,mx,px,Lx,ex,Lwx,ewx)) %>%
mutate(inc_num_bl   = incidence_disease_bl*(1-px_bl)*Lx_bl,
inc_num_sc   = incidence_disease_sc*(1-px_sc)*Lx_sc,
inc_num_diff = inc_num_sc-inc_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = cause,
values_from = incidence_disease_sc:mx_num_diff)
disease_combined <- bind_rows(scenario_d,baseline_d) %>%
pivot_wider(names_from  = intervention,
values_from = c(incidence_disease,mx,px,Lx),
values_fill = 0) %>%
mutate(inc_num_bl   = incidence_disease_bl*(1-px_bl)*Lx_bl,
inc_num_sc   = incidence_disease_sc*(1-px_sc)*Lx_sc,
inc_num_diff = inc_num_sc-inc_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = cause,
values_from = inc_num_bl:mx_num_diff,
values_fill = 0) %>%
dplyr::select(-starts_with(c("Lx", "px", "incidence_")))
scenario_nd <- inner_join(non_disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,mx,ylds_rate, diff_mort, diff_pylds),
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx),
by=c("age","sex","age_group")) %>%
mutate(intervention="sc")
baseline_nd <- inner_join(non_disease_life_table_sc %>%
dplyr::select(age_group,sex,age,cause,mx,ylds_rate, diff_mort, diff_pylds),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx),
by=c("age","sex","age_group")) %>%
mutate(intervention="bl")
non_disease_combined <- bind_rows(scenario_nd,baseline_nd) %>%
pivot_wider(names_from  = intervention,
values_from = c(mx, ylds_rate, Lx,
values_fill=0)) %>%
mutate(ylds_num_bl   = ylds_rate_bl*Lx_bl,
ylds_num_sc   = ylds_rate_sc*Lx_sc,
ylds_num_diff = ylds_num_sc-ylds_num_bl,
mx_num_bl    = mx_bl*Lx_bl,
mx_num_sc    = mx_sc*Lx_sc,
mx_num_diff  = mx_num_sc-mx_num_bl) %>%
pivot_wider(names_from  = cause,
values_from = diff_mort:mx_num_diff,
values_fill=0) %>%
dplyr::select(-starts_with("Lx"))
### General life tables
general_lf <- bind_rows(
general_life_table_sc %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx) %>%
mutate(intervention="sc"),
general_life_table_bl %>%
dplyr::select(age_group,sex,age,Lx,ex,Lwx,ewx) %>%
mutate(intervention="bl")) %>%
pivot_wider(names_from  = intervention,
values_from = c(Lx,ex,Lwx,ewx),
values_fill=0) %>%
mutate(Lx_diff  = Lx_sc-Lx_bl,
Lwx_diff = Lwx_sc-Lwx_bl,
ex_diff  = ex_sc-ex_bl,
ewx_diff = ewx_sc-ewx_bl)
output_df <- inner_join(disease_combined,
general_lf,
by=c("age","sex","age_group")) %>%
inner_join(non_disease_combined,
by=c("age","sex","age_group"))
### Generte outputs
#### Summary data frame by age and sex and total
######## Dataframe with all outputs aggregated by year of simlation by sex
output_df_agg_sex  <- output_df   %>% ### Create a simulation year columns
group_by(age_group, sex, .add=TRUE) %>%
dplyr::mutate(year = 1:dplyr::n()) %>%
dplyr::select(sex, year, Lx_bl, Lx_sc, Lx_diff, Lwx_bl, Lwx_sc, Lwx_diff, contains("num")) %>%
ungroup() %>%
group_by(year, sex, .add=TRUE) %>%
summarise_if(is.numeric, funs(sum)) %>%
ungroup()
View(output_df_agg_sex)
source(paste0(relative_path_mslt, "R/RunMSLT.R"))
#### Graphs for changes in diseases over time
outputs <- RunMSLT(
mslt_df=read_csv("C:\\Metahit\\mh-execute\\inputs\\mslt\\bristol_mslt.csv"),
disease_names=readRDS("C:\\Metahit\\mh-mslt\\output\\parameters\\DISEASE_SHORT_NAMES.rds"),
i_sex=c("male", "female"),
i_age_cohort=seq(from=17, to=97, by =5),
pif=read_csv("C:\\Metahit\\mh-mslt\\input\\pif.csv")
)
View(outputs)
output_df_agg_sex  <- output_df   %>% ### Create a simulation year columns
group_by(age_group, sex, .add=TRUE) %>%
dplyr::mutate(year = 1:dplyr::n()) %>%
dplyr::select(sex, age_group,year, Lx_bl, Lx_sc, Lx_diff, Lwx_bl, Lwx_sc, Lwx_diff, contains("num")) %>%
ungroup() %>%
group_by(year, sex, .add=TRUE) %>%
summarise_if(is.numeric, funs(sum)) %>%
ungroup()
unique(output_df$age_group)
output_df <- inner_join(disease_combined,
general_lf,
by=c("age","sex","age_group")) %>%
inner_join(non_disease_combined,
by=c("age","sex","age_group"))
### Generte outputs
#### Summary data frame by age and sex and total
######## Dataframe with all outputs aggregated by year of simlation by sex
output_df_agg_sex  <- output_df   %>% ### Create a simulation year columns
group_by(age_group, sex, .add=TRUE) %>%
dplyr::mutate(year = 1:dplyr::n())
unique(output_df_agg_sex$year)
